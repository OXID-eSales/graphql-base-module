prepare_shop:
  matrix: &matrix
    php: &matrix_php '["8.1", "8.2"]'
    mysql: &matrix_mysql '["8.0"]'
  specific: &specific_matrix
    php: '["8.1"]'
    mysql: '["8.0"]'
  git:
    shop_ref: '{{ .Data.global.git.default_ref }}'
  composer_require_install: 'codeception/module-rest:^3.3 codeception/module-phpbrowser:^3.0 codeception/c3'
  composer_require_options: '--dev'
  composer_allow_plugins_repositories: 'codeception/c3:true'
  custom_ini:
    xdebug: 'xdebug.mode=coverage'

install_shop:
  matrix: *matrix

install_module:
  matrix:
    <<: *matrix
    testplan: '["-"]'
  cache:
    prefix: &install_module_prefix 'moduleInstallation-ce-{{ .Github.SHA }}-{{ .Github.RunNumber }}-{{ .Github.RunAttempt }}'
  ids: &ids 'oe_graphql_base'
  activate: *ids
  git:
    module:
      url: &git_module_url '{{ .Github.Repository }}'
      ref: '{{ .Github.RefName }}'
  package_name: &package_name 'oxid-esales/graphql-base'
  path: *ids

phpunit:
  matrix:
    <<: *matrix
    testplan: '["tests/github_actions/defaults/module_phpunit_unit.yml","tests/github_actions/defaults/module_phpunit_integration.yml"]'
  load_shop: *install_module_prefix

codeception:
  matrix:
    <<: *matrix
    testplan: '["-"]'
  load_shop: *install_module_prefix
  title: codeception
  container:
    options: '-e SELENIUM_SERVER_HOST=selenium -e BROWSER_NAME=chrome -e XDEBUG_MODE=coverage -e THEME_ID=apex'
  configuration: '/var/www/vendor/oxid-esales/graphql-base/tests/codeception.yml'
  suite: 'Acceptance'
  additional_options: '--coverage-xml=/var/www/codeception_coverage.xml'
  logfile:
    prefix: 'codeception'
  output:
    prefix: 'codeception-artifacts'
  coverage:
    path: 'source/codeception_coverage.xml'
  custom_script: |
    perl -pi -e 'print "SetEnvIf Authorization \"(.*)\" HTTP_AUTHORIZATION=\$1\n\n" if $. == 1' source/source/.htaccess
    sed -i 's/<?php/<?php\n\nrequire(__DIR__ . "\/..\/c3.php");/' source/source/bootstrap.php

runtest:
  matrix:
    testplan: 'skip'
  load_shop: *install_module_prefix

sonarcloud:
  matrix:
    <<: *specific_matrix
    testplan: '["-"]'
  project_key: 'OXID-eSales_graphql-base-module'
  project_name: *package_name
  parameters: |
    -Dsonar.language=php
    -Dsonar.scm.provider=git
    -Dsonar.sources=src
    -Dsonar.tests=tests

phpcs_tests:
  skip: true

styles:
  matrix:
    <<: *specific_matrix
    testplan: '["-"]'
  load_shop: *install_module_prefix
  path: *ids
  module_ids: *ids

finish:
  slack_title: 'Module oe_graphql_base on {{ .Github.Repository }} by {{ .Github.Actor }}'
